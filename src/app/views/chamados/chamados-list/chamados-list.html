<div class="chamados-container">
  <!-- CABE√áALHO -->
  <div class="chamados-header">
    <h1 class="chamados-title"> Chamados</h1>
    <div class="chamados-stats">
      <div class="stat-card">
        <span class="stat-number">{{ totalChamados() }}</span>
        <span class="stat-label">Total</span>
      </div>
      <div class="stat-card">
        <span class="stat-number">{{ totalAbertos() }}</span>
        <span class="stat-label">Abertos</span>
      </div>
      <div class="stat-card">
        <span class="stat-number">{{ totalEmAndamento() }}</span>
        <span class="stat-label">Em Andamento</span>
      </div>
      <div class="stat-card">
        <span class="stat-number">{{ totalFechados() }}</span>
        <span class="stat-label">Fechados</span>
      </div>
    </div>
  </div>

  <!-- A√á√ïES E FILTROS -->
  <div class="actions">
    <div class="filtros-container">
      <!-- BUSCA -->
      <div class="search-box">
        <input 
          type="text" 
          placeholder="Buscar por t√≠tulo, descri√ß√£o, cliente..."
          [value]="termoBusca()"
          (input)="onBuscarChamados($any($event.target).value)">
      </div>

      <!-- FILTRO POR STATUS -->
      <div class="filtro-status">
        <label>Filtrar por Status:</label>
        <div class="status-buttons">
          <button 
            class="status-btn {{filtroStatus() === 'TODOS' ? 'active' : ''}}"
            (click)="alterarFiltroStatus('TODOS')">
            üìÅ Todos
          </button>
          <button 
            class="status-btn status-aberto {{filtroStatus() === 'ABERTO' ? 'active' : ''}}"
            (click)="alterarFiltroStatus('ABERTO')">
            üî¥ Abertos
          </button>
          <button 
            class="status-btn status-andamento {{filtroStatus() === 'EM_ANDAMENTO' ? 'active' : ''}}"
            (click)="alterarFiltroStatus('EM_ANDAMENTO')">
            üü° Em Andamento
          </button>
          <button 
            class="status-btn status-fechado {{filtroStatus() === 'FECHADO' ? 'active' : ''}}"
            (click)="alterarFiltroStatus('FECHADO')">
            üü¢ Fechados
          </button>
        </div>
      </div>

    </div>

    <!-- BOT√ÉO NOVO CHAMADO -->
    <button routerLink="/chamados/novo" class="btn btn-primary">
      ‚ûï Novo Chamado
    </button>
  </div>

  <!-- LISTA DE CHAMADOS -->
  @if (chamadosFiltrados(); as chamados) {
    @if (chamados.length === 0) {
      <div class="no-data">
        <p> Nenhum chamado encontrado</p>
        <p class="no-data-sub">Tente alterar os filtros de busca</p>
        <button routerLink="/chamados/novo" class="btn btn-primary mt-2">
          ‚ûï Criar Primeiro Chamado
        </button>
      </div>
    } @else {
      <div class="chamados-grid">
        @for (chamado of chamados; track chamado.id) {
          <div class="chamado-card {{chamado.status.toLowerCase()}}">
            
            <!-- HEADER DO CARD -->
            <div class="chamado-header">
              <h3 class="chamado-titulo">{{ chamado.titulo }}</h3>
              <span class="chamado-status status-{{chamado.status.toLowerCase()}}">
                @switch (chamado.status) {
                  @case ('ABERTO') { üî¥ Aberto }
                  @case ('EM_ANDAMENTO') { üü° Em Andamento }
                  @case ('FECHADO') { üü¢ Fechado }
                }
              </span>
            </div>
            
            <!-- INFORMA√á√ïES DO CHAMADO -->
            <div class="chamado-info">
              <p class="chamado-descricao">{{ chamado.descricao }}</p>
              
              <div class="chamado-detalhes">
                <!-- CLIENTE -->
                <div class="detalhe-item">
                  <strong>üë§ Cliente:</strong> 
                  <span>{{ chamado.cliente?.nome || 'Cliente n√£o encontrado' }}</span>
                </div>
                
                <!-- T√âCNICO -->
                <div class="detalhe-item">
                  <strong>üîß T√©cnico:</strong> 
                  @if (chamado.tecnico) {
                    <span>
                      {{ chamado.tecnico.nome }}
                      <span class="tecnico-indisponivel">(Ocupado)</span>
                    </span>
                  } @else if (chamado.status === 'ABERTO') {
                    <span class="sem-tecnico">Aguardando atribui√ß√£o</span>
                  } @else {
                    <span>N√£o atribu√≠do</span>
                  }
                </div>

                <!-- DATAS -->
                <div class="detalhe-item">
                  <strong>üìÖ Aberto em:</strong> 
                  <span>{{ chamado.dataAbertura | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
                
                @if (chamado.dataFechamento) {
                  <div class="detalhe-item">
                    <strong>‚úÖ Fechado em:</strong> 
                    <span>{{ chamado.dataFechamento | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                }

                <!-- PRIORIDADE -->
                <div class="detalhe-item">
                  <strong>üö® Prioridade:</strong> 
                  <span class="prioridade prioridade-{{chamado.prioridade.toLowerCase()}}">
                    {{ chamado.prioridade }}
                  </span>
                </div>

                <!-- ID DO CHAMADO -->
                <div class="detalhe-item">
                  <strong>üÜî ID:</strong> 
                  <span>#{{ chamado.id }}</span>
                </div>
              </div>
            </div>

            <!-- ATRIBUI√á√ÉO DE T√âCNICO (APENAS PARA CHAMADOS ABERTOS) -->
            @if (chamado.status === 'ABERTO') {
              <div class="atribuicao-container">
                <label for="tecnico-{{chamado.id}}">Atribuir T√©cnico:</label>
                <select 
                  id="tecnico-{{chamado.id}}"
                  #tecnicoSelect
                  class="form-control tecnico-select"
                  (change)="atribuirTecnico(chamado.id, +tecnicoSelect.value)">
                  
                  <option value="">Selecione um t√©cnico dispon√≠vel...</option>
                  @for (tecnico of tecnicoDisponiveis(); track tecnico.id) {
                    <option [value]="tecnico.id">
                      {{ tecnico.nome }} - {{ tecnico.especialidade }} 
                      <span class="tecnico-disponivel">(Dispon√≠vel)</span>
                    </option>
                  }
                  
                  @if (tecnicoDisponiveis().length === 0) {
                    <option value="" disabled>üòî Nenhum t√©cnico dispon√≠vel no momento</option>
                  }
                </select>
                
                @if (tecnicoDisponiveis().length > 0) {
                  <div class="mt-1 text-center">
                    <small class="text-muted">
                      {{ tecnicoDisponiveis().length }} t√©cnico(s) dispon√≠vel(is)
                    </small>
                  </div>
                }
              </div>
            }

            <!-- A√á√ïES DO CHAMADO -->
            <div class="chamado-actions">
              <!-- BOT√ÉO EDITAR (SEMPRE VIS√çVEL) -->
              <button 
                [routerLink]="['/chamados/editar', chamado.id]" 
                class="btn btn-edit">
                ‚úèÔ∏è Editar
              </button>

              <!-- A√á√ïES ESPEC√çFICAS POR STATUS -->
              @switch (chamado.status) {
                <!-- CHAMADOS EM ANDAMENTO -->
                @case ('EM_ANDAMENTO') {
                  <button 
                    class="btn btn-fechar" 
                    (click)="fecharChamado(chamado.id)">
                    ‚úÖ Fechar
                  </button>
                }
                
                <!-- CHAMADOS FECHADOS -->
                @case ('FECHADO') {
                  <button 
                    class="btn btn-secondary" 
                    disabled
                    title="Chamado finalizado">
                    üèÅ Finalizado
                  </button>
                  
                }
                
                <!-- CHAMADOS ABERTOS (BOT√ÉO ATRIBUIR R√ÅPIDO) -->
                @case ('ABERTO') {
                  @if (tecnicoDisponiveis().length > 0) {
                    <button 
                      class="btn btn-atribuir"
                      (click)="atribuirTecnicoRapido(chamado.id)">
                      üë§ Atribuir R√°pido
                    </button>
                  }
                }
              }
            </div>

            <!-- INDICADOR DE STATUS -->
            <div class="mt-2 text-center">
              <small [class]="getStatusClass(chamado.status)">
                @switch (chamado.status) {
                  @case ('ABERTO') { ‚è≥ Aguardando atendimento }
                  @case ('EM_ANDAMENTO') { üîß Em atendimento }
                  @case ('FECHADO') { ‚úÖ Finalizado }
                }
              </small>
            </div>
          </div>
        }
      </div>

      <!-- PAGINA√á√ÉO (OPCIONAL) -->
      @if (chamados.length > 6) {
        <div class="pagination">
          <div class="pagination-info">
            Mostrando {{ chamados.length }} de {{ totalChamados() }} chamados
          </div>
          <div class="pagination-controls">
            <button class="pagination-btn" disabled>‚Äπ Anterior</button>
            <button class="pagination-btn active">1</button>
            <button class="pagination-btn">2</button>
            <button class="pagination-btn">3</button>
            <button class="pagination-btn">Pr√≥ximo ‚Ä∫</button>
          </div>
        </div>
      }
    }
  } @else {
    <!-- LOADING -->
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>Carregando chamados...</p>
    </div>
  }

  <!-- RESUMO DOS FILTROS ATIVOS -->
  @if (filtroStatus() !== 'TODOS' || termoBusca()) {
    <div class="mt-3 p-2 text-center">
      <small class="text-muted">
        @if (filtroStatus() !== 'TODOS' && termoBusca()) {
          Mostrando resultados filtrados por: <strong>{{ filtroStatus() }}</strong> 
          e busca: <strong>"{{ termoBusca() }}"</strong>
        } @else if (filtroStatus() !== 'TODOS') {
          Mostrando apenas chamados: <strong>{{ filtroStatus() }}</strong>
        } @else if (termoBusca()) {
          Buscando por: <strong>"{{ termoBusca() }}"</strong>
        }
        ‚Ä¢ 
        <a href="javascript:void(0)" (click)="limparFiltroBusca()" class="text-primary">
            <span>Limpar filtros</span>   
        </a>
      </small>
    </div>
  }
</div>